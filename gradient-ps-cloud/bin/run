#! /usr/bin/env bash

# Note: Terraform reads vars from env vars that are prefixed TF_VARS_,
# and they'll be named whatever the rest of the env var name is.

if [ $TF_VAR_is_managed == "true" ] ; then
  echo "Configuring managed backend..."

  cat << EOF > ./backend.tf
terraform {
    backend "s3" {
        bucket = "${AWS_BUCKET}"
        key    = "gradient-processing-ps-cloud-managed"
        region = "${AWS_DEFAULT_REGION}"
    }
}
EOF
fi

terraform init
terraform workspace new $TF_VAR_cluster_handle || true
terraform workspace select $TF_VAR_cluster_handle

export PAPERSPACE_API_KEY=$TF_VAR_admin_user_api_key
export PAPERSPACE_API_HOST=$TF_VAR_api_host
export PAPERSPACE_REGION=$TF_VAR_region

if [ "$TERRAFORM_COMMAND" = "destroy" ]; then
  terraform state rm module.gradient_metal.module.gradient_processing
  terraform state rm module.gradient_metal.module.kubernetes
  terraform destroy -auto-approve
else
  terraform apply -auto-approve
fi
