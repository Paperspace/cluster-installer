#! /usr/bin/env bash

# Note: Terraform reads vars from env vars that are prefixed TF_VARS_,
# and they'll be named whatever the rest of the env var name is.

if [ $TF_VAR_is_managed == "true" ] ; then
  echo "Configuring managed backend..."

  cat << EOF > ./backend.tf
terraform {
    backend "s3" {
        bucket = "${AWS_BUCKET}"
        key    = "gradient-processing-ps-cloud-managed"
        region = "${AWS_DEFAULT_REGION}"
    }
}
EOF
fi

terraform init
terraform workspace new $TF_VAR_cluster_handle || true
terraform workspace select $TF_VAR_cluster_handle

if [ $TERRAFORM_COMMAND == "destroy" ] ; then
  terraform destroy
  exit 0
fi

terraform apply
